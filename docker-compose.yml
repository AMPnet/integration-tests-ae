version: '3'

services:
  db:
    build:
      context: ./db
    image: integration-db
    environment:
      - POSTGRES_PASSWORD=postgres
    ports:
      - 5432:5432

  project-service:
    image: ampnet/project-service:amqp
    environment:
      - "spring.profiles.active=integration-test"
    depends_on:
       - db
    ports:
       - 8123:8123

  wallet-service:
    image: ampnet/wallet-service:amqp
    environment:
      - "spring.profiles.active=integration-test"
    depends_on:
       - db
    ports:
       - 8128:8128

  blockchain-service:
    image: ampnet/crowdfunding-ae-middleware:latest
    environment:
      NODE_ENV: local
      NODE_URL: http://ae-node:3013
      NODE_INTERNAL_URL: http://ae-node:3113
      COMPILER_URL: http://sophia-compiler:3080
      NETWORK_ID: ae_docker
      REDIS_HOST: redis
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: ae_middleware_testnet
      DB_PASSWORD: password
      DB_NAME: ae_middleware_testnet
      WALLET_SERVICE_GRPC_URL: wallet-service:8228
    restart: always
    depends_on:
      - db
      - ae-node
      - sophia-compiler
      - redis
    ports:
      - 8124:8124
      - 8224:8224

  user-service:
    image: ampnet/user-service:amqp
    environment:
      - "spring.profiles.active=integration-test"
    depends_on:
      - db
    ports:
      - 8125:8125

  report-service:
    image: ampnet/report-service:latest
    environment:
      - "spring.profiles.active=dev"
    ports:
      - 8129:8129

  ae-node:
    image: aeternity/aeternity:v5.5.4
    environment:
      AETERNITY_CONFIG: /home/aeternity/aeternity.yaml
    volumes:
      - ${PWD}/node/config/singlenode_mean15.yaml:/home/aeternity/aeternity.yaml
      - ${PWD}/node/config/accounts_test.json:/home/aeternity/node/data/aecore/.genesis/accounts_test.json
      - ${PWD}/node/keys/node1:/home/aeternity/node/keys
    ports:
     - "3013:3013"
     - "3113:3113"
     - "3014:3014"

  sophia-compiler:
    image: aeternity/aesophia_http:v4.3.2
    ports:
       - "3080:3080"

  auto-funder:
    image: ampnet/auto-funder:latest
    environment:
      NODE_URL: http://ae-node:3013
      NODE_INTERNAL_URL: http://ae-node:3113
      COMPILER_URL: http://sophia-compiler:3080
      FUNDERS: 707881878eacacce4db463de9c7bf858b95c3144d52fafed4a41ffd666597d0393d23cf31fcd12324cd45d4784d08953e8df8283d129f357463e6795b40e88aa
      REDIS_HOST: redis
    restart: always
    depends_on:
      - ae-node
      - sophia-compiler
      - db
      - redis
    ports:
      - "8130:8130"

  redis:
    image: redis:latest
    ports:
      - 6379:6379

  rabbitmq:
    image: rabbitmq:3.8-alpine
    ports:
      - 5672:5672
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
